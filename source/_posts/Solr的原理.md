---
title: Solr原理
date: 2017-12-15 22:27:08
tags: [solr,倒排索引,Lucene]
---

Lucene&solr
===

1.Lucene简介
---

​	Lucene是apache下的一个开放源代码的全文检索引擎工具包。提供了完整的查询引擎和索引引擎，部分文本分析引擎。Lucene的目的是为软件开发人员提供一个简单易用的工具包，以方便的在目标系统中实现全文检索的功能。

​	Lucene是一套用于全文检索和搜寻的开源程式库，由Apache软件基金会支 持和提供,Lucene提供了一个简单却强大的应用程式接口，能够做全文索引和搜寻，   在Java开发环境里Lucene是一个成熟的免费开放源代码工具

​	==Lucene并不是现成的搜索引擎产品，但可以用来制作搜索引擎产品==

2. Lucene与搜索引擎的区别
---

​	全文检索系统是按照全文检索理论建立起来的用于提供全文检索服务的软件系统，包括建立索引、处理查询返回结果集、增加索引、优化索引结构等功能。例如：百度搜索、eclipse帮助搜索、淘宝网商品搜索等。

​	搜索引擎是全文检索技术最主要的一个应用，例如百度。搜索引擎起源于传统的信息全文检索理论，即计算机程序通过扫描每一篇文章中的每一个词，建立以词为单位的倒排文件，检索程序根据检索词在每一篇文章中出现的频率和每一个检索词在一篇文章中出现的概率，对包含这些检索词的文章进行排序，最后输出排序的结果。全文检索技术是搜索引擎的核心支撑技术。

​	Lucene和搜索引擎不同，Lucene是一套用java或其它语言写的全文检索的工具包，为应用程序提供了很多个api接口去调用，可以简单理解为是一套实现全文检索的类库，搜索引擎是一个全文检索系统，它是一个单独运行的软件系统

3.Lucene主要包
---

| 包名                            | 功能                                       |
| ----------------------------- | ---------------------------------------- |
| org.apache.lucene.analysis    | 语言分析器，主要用于的切词  Lucene提供的分析器实现类在：  lucene-analyzers-common-4.10.3.jar |
| org.apache.lucene.document    | 索引存储时的文档结构管理，类似于关系型数据库的表结构               |
| org.apache.lucene.index       | 索引管理，包括索引建立、删除等                          |
| org.apache.lucene.queryParser | 查询分析器，实现查询关键词间的运算，如与、或、非等, 生成查询表达式，      |
| org.apache.lucene.search      | 检索管理，根据查询条件，检索得到结果                       |
| org.apache.lucene.store       | 数据存储管理，包括一些I/O操作                         |
| org.apache.lucene.util        | 公用类                                      |

4.创建索引和搜索流程
---

![mark](http://ozaomob5f.bkt.clouddn.com/images/171224/K8Bm7HFh6B.png?imageslim)

1、创建索引过程，对要搜索的原始内容进行索引构建一个索引库，索引过程包括：

​	确定原始内容即要搜索的内容=>获得文档=>创建文档=>分析文档à索引文档

2、红色表示搜索[过程]()，从索引库中搜索内容，搜索过程包括：

​	用户通过搜索界面=>创建查询=>执行搜索，从索引库搜索=>渲染搜索结果

5.Solr与Lucene区别
---

[Lucene]()是一个开放源代码的全文检索引擎工具包，它不是一个完整的全文检索应用。Lucene仅提供了完整的查询引擎和索引引擎，目的是为软件开发人员提供一个简单易用的工具包，以方便的在目标系统中实现全文检索的功能，或者以Lucene为基础构建全文检索应用。

 Solr的目标是打造一款企业级的搜索引擎系统，它是基于Lucene一个搜索引擎服务，可以独立运行，通过Solr可以非常快速的构建企业的搜索引擎，通过Solr也可以高效的完成站内搜索功能。

6.搜索数据方式
---

### 6.1 顺序扫描

所谓顺序扫描，例如要找内容包含一个字符串的文件，就是一个文档一个文档的看，对于每一个文档，从头看到尾，如果此文档包含此字符串，则此文档为我们要找的文件，接着看下一个文件，直到扫描完所有的文件。这种方法是顺序扫描方法，数据量大就搜索慢。

### 6.2 倒排索引

倒排索引（也称为倒排文件）是一种存储了来自文本中的映射的索引数据结构。比如单词或者数字，对应到它们在数据库、一个文件或者一组文件中的位置。它是在文档检索系统中使用的最流行的数据结构，在搜索引擎中有大规模使用案例

例如我们使用新华字典查询汉字，新华字典有偏旁部首的目录（索引），我们查字首先查这个目录，找到这个目录中对应的偏旁部首，就可以通过这个目录中的偏旁部首找到这个字所在的位置（文档）

倒排索引做两件事情：

1、提取资源中关键信息， 建立索引 （目录）

2、搜索时，根据关键字（目录），找到资源的位置

**文档（Document）**：一般搜索引擎处理的对象是互联网网页，对于搜索引擎来讲，Word、PDF、html、XML等不同格式的文件都可以称为文档，一般以文档来表示文本信息。

**文档集合（DocumentCollection）**：由若干文档构成的集合成为文档集合。比如海量的互联网网页等。

**文档编号（Document ID）**：在搜索引擎内部，会为文档集合每个文档赋予一个唯一的内部编号，以作为文档的唯一标识，以便于处理。

**单词编号（Word ID）**：与文档编号类似，搜索引擎内部以唯一的编号来表示某个单词，以作为某个单词的唯一表示。

**倒排索引（Inverted Index）**：倒排索引是实现单词——**文档矩阵**的一种具体存储形式。通过倒排索引，可以根据单次快速获取包含这个单词的文档列表。倒排索引主要由两个部分组成：**单词词典和倒排文件**。

**单词词典（Lexicon）**：搜索引擎通常的索引单位是单词，单词词典是由文档集合中出现过的所有单词构成的字符串集合，单词词典内每条索引记载单词本身的一些信息及指向倒排列表的指针。单词也就是我们在搜索时的一些关键字，也称为词条。

**倒排列表（PostingList）**：倒排列表记载了出现过某个单词的所有文档的文档列表及单词在该文当中出现的位置信息，每条记录成为一个倒排向（Posting）。根据倒排列表，即可获知哪些文档包含某个单词。

**倒排文件（Inverted File）**：所有单词的倒排列表往往顺序地存储在磁盘的某个文件里，这个文件即为倒排文件，倒排文件是存储倒排索引的物理文件。

7.  倒排索引
---

### 7.1单词-文档矩阵的基本模型：

![mark](http://ozaomob5f.bkt.clouddn.com/images/171224/Ch5G2E7DHE.png?imageslim)

该矩阵模型代表的含义：

词1在文档1、文档4中出现，文档1包含了词1和词4。

词2在文档2、文档5中出现，文档2包含词2。

### 7.2 创建倒排索引过程

![mark](http://ozaomob5f.bkt.clouddn.com/images/171224/2HAJd0GK6d.png?imageslim)



### 7.3 基本倒排索引结构

![mark](http://ozaomob5f.bkt.clouddn.com/images/171224/964676fHlF.png?imageslim)

第1列单词ID即为每个单词的编号。 

第2列即为对应的单词。 

第3列即为每个单词对应的倒排序表。（比如单词“拉斯”，单词编号为8，倒排序表为｛3，5｝，说明文档集合中文档3和文档5包含这个单词。）

### 7.4  复杂倒排索引结构

![mark](http://ozaomob5f.bkt.clouddn.com/images/171224/CGid1D84i7.png?imageslim)

就编号8—拉斯—｛（3：1）；（5，1）｝来说，（3，1）表示“拉斯”在文档3中出现一次，（5，1）表示“拉斯”在文档5中出现1次。

### 7.5 完整倒排索引结构

![mark](http://ozaomob5f.bkt.clouddn.com/images/171224/368g0ciF2g.png?imageslim)

就编号8—拉斯—2—｛（3;1;<4>），（5;1;<4>）｝来说，文档频率2表示在两个文档出现。“<4>”表示单词出现的位置是文档中的第4个单词。 

这个倒排索引基本上是一个完备的索引系统了，实际搜索系统的索引结构基本如此。

8. 单词词典
---

单词词典是倒排索引中非常重要的组成部分，它用来维护文档集合中出现过的所有单词的相关信息，同时用来记载某个单词对应的倒排列表在倒排文件中的位置信息。在支持搜索时，根据用户的查询词，去单词词典里查询，就能够获得相应的倒排列表，并以此作为后续排序的基础。
​       对于一个规模很大的文档集合来说，可能包含几十万甚至上百万的不同单词，能否快速定位某个单词，这直接影响搜索时的响应速度，所以需要高效的数据结构来对单词词典进行构建和查找，常用的数据结构包括哈希加链表结构和树形词典结构。

4.1   哈希加链表

​       图1-7是这种词典结构的示意图。这种词典结构主要由两个部分构成：

​        主体部分是哈希表，每个哈希表项保存一个指针，指针指向冲突链表，在冲突链表里，相同哈希值的单词形成链表结构。之所以会有冲突链表，是因为两个不同单词获得相同的哈希值，如果是这样，在哈希方法里被称做是一次冲突，可以将相同哈希值的单词存储在链表里，以供后续查找。
​                       ![img](http://img.my.csdn.net/uploads/201209/10/1347269599_3828.jpg)

​                        图1-7  哈希加链表词典结构

​       在建立索引的过程中，词典结构也会相应地被构建出来。比如在解析一个新文档的时候，对于某个在文档中出现的单词T，首先利用哈希函数获得其哈希值，之后根据哈希值对应的哈希表项读取其中保存的指针，就找到了对应的冲突链表。如果冲突链表里已经存在这个单词，说明单词在之前解析的文档里已经出现过。如果在冲突链表里没有发现这个单词，说明该单词是首次碰到，则将其加入冲突链表里。通过这种方式，当文档集合内所有文档解析完毕时，相应的词典结构也就建立起来了。

​        在响应用户查询请求时，其过程与建立词典类似，不同点在于即使词典里没出现过某个单词，也不会添加到词典内。以图1-7为例，假设用户输入的查询请求为单词3，对这个单词进行哈希，定位到哈希表内的2号槽，从其保留的指针可以获得冲突链表，依次将单词3和冲突链表内的单词比较，发现单词3在冲突链表内，于是找到这个单词，之后可以读出这个单词对应的倒排列表来进行后续的工作，如果没有找到这个单词，说明文档集合内没有任何文档包含单词，则搜索结果为空。

**4.2   树形结构**
​       B树（或者B+树）是另外一种高效查找结构，图1-8是一个 B树结构示意图。B树与哈希方式查找不同，需要字典项能够按照大小排序（数字或者字符序），而哈希方式则无须数据满足此项要求。
​       B树形成了层级查找结构，中间节点用于指出一定顺序范围的词典项目存储在哪个子树中，起到根据词典项比较大小进行导航的作用，最底层的叶子节点存储单词的地址信息，根据这个地址就可以提取出单词字符串。
​                  ![img](http://img.my.csdn.net/uploads/201209/10/1347269740_2402.jpg)
​                                           图1-8  B树查找结构 



